
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Syncing Configs &#8212; Ciruela 0.6.12 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Remote Editing" href="editing-configs.html" />
    <link rel="prev" title="Use Cases" href="index.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="syncing-configs">
<span id="id1"></span><h1>Syncing Configs<a class="headerlink" href="#syncing-configs" title="Permalink to this headline">¶</a></h1>
<p>Let’s say we want to configure a daemon called <code class="docutils literal notranslate"><span class="pre">demonio</span></code> (which is spanish
for daemon).</p>
<p>About <code class="docutils literal notranslate"><span class="pre">daemonio</span></code>:</p>
<ol class="arabic simple">
<li>It stores it’s configs in the directory <code class="docutils literal notranslate"><span class="pre">/etc/daemonio.d</span></code></li>
<li>It can detect configuration changes itself
(See <a class="reference internal" href="#reloading"><span class="std std-ref">Reloading Configs</span></a>)</li>
<li>This config of daemon is named <code class="docutils literal notranslate"><span class="pre">my_daemonio</span></code> <a class="footnote-reference" href="#instances" id="id2">[1]</a></li>
</ol>
<table class="docutils footnote" frame="void" id="instances" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td>If we ever run multiple instances of the daemon on the same
machine or accross the same cluster we need to differentiate different
config folders</td></tr>
</tbody>
</table>
<div class="section" id="server-setup">
<h2>Server Setup<a class="headerlink" href="#server-setup" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Configure the service to read configs from <code class="docutils literal notranslate"><span class="pre">/etc/daemonio-configs/current</span></code> instead of <code class="docutils literal notranslate"><span class="pre">/etc/daemonio.d</span></code></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The point here is: ciruela can sync whole directory of configs and
replace it atomically. But to do that we need to grant access for user
to the parent directory of the actual config folder. We don’t want to
grant access to the whole <code class="docutils literal notranslate"><span class="pre">/etc</span></code>.</p>
</div>
</li>
<li><p class="first">Drop the following file into <code class="docutils literal notranslate"><span class="pre">/etc/ciruela/configs/my-daemonio.yaml</span></code>:</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">directory</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/daemonio-configs</span>
<span class="l l-Scalar l-Scalar-Plain">num-levels</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="l l-Scalar l-Scalar-Plain">append-only</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="l l-Scalar l-Scalar-Plain">upload-keys</span><span class="p p-Indicator">:</span> <span class="p p-Indicator">[</span><span class="nv">my_daemonio</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p class="first">Drop the <strong>public key</strong> allowed to upload new config into
<code class="docutils literal notranslate"><span class="pre">/etc/ciruela/keys/my_daemonio.key</span></code>. (See <a class="reference internal" href="#client-setup">Client Setup</a>)</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Multiple keys can be put into the file as well as multiple files
can be specified in <code class="docutils literal notranslate"><span class="pre">upload-keys</span></code> in the configuration of the
directory. It’s useful to create a file per actual user (potentially
having multiple keys) or organize keys in any way you want.</p>
</div>
</li>
<li><p class="first">Set <code class="docutils literal notranslate"><span class="pre">ciruela</span></code> as the owner of all the directories it should sync:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">ciruela</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">daemonio</span><span class="o">-</span><span class="n">configs</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="client-setup">
<h2>Client Setup<a class="headerlink" href="#client-setup" title="Permalink to this headline">¶</a></h2>
<div class="section" id="human-operator-setup">
<h3>Human Operator Setup<a class="headerlink" href="#human-operator-setup" title="Permalink to this headline">¶</a></h3>
<p>This is mostly useful for testing, because work well mostly for a single user.</p>
<ol class="arabic">
<li><p class="first">Generate a key, it’s same as ssh but in <code class="docutils literal notranslate"><span class="pre">ed25519</span></code> format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span><span class="o">-</span><span class="n">keygen</span> <span class="o">-</span><span class="n">t</span> <span class="n">ed25519</span> <span class="o">-</span><span class="n">f</span> <span class="o">~/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_ciruela</span> <span class="o">-</span><span class="n">P</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>Ciruela doesn’t support password-protected keys yet.</p>
<p>This also means you can use your normal <code class="docutils literal notranslate"><span class="pre">~/.ssh/id_ed25519</span></code> key, if
it isn’t password-protected, but leaving ssh key plain-text isn’t good
idea. Ciruela keys are much more lower risk because they allow only
uploading a limited set of directories rather than executing any
script.</p>
<p class="last">Also you may wish to delete the key and use CI system when you finish
testing the setup.</p>
</div>
</li>
<li><p class="first">Upload the key into <code class="docutils literal notranslate"><span class="pre">/etc/ciruela/keys/my_daemonio.key</span></code>.</p>
</li>
<li><p class="first">Run the following every time you need to upload new configs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ciruela</span> <span class="n">sync</span> <span class="n">server</span><span class="o">.</span><span class="n">name</span> <span class="o">--</span><span class="n">replace</span> <span class="n">local</span><span class="o">/</span><span class="n">config</span><span class="o">/</span><span class="n">path</span><span class="p">:</span><span class="o">/</span><span class="n">my</span><span class="o">-</span><span class="n">daemonio</span><span class="o">/</span><span class="n">current</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="ci-setup">
<h3>CI Setup<a class="headerlink" href="#ci-setup" title="Permalink to this headline">¶</a></h3>
<p>Usually CI systems allow to put secret variables into environment, so
you can use <code class="docutils literal notranslate"><span class="pre">CIRUELA_KEY</span></code> environment variable for storing keys.</p>
<ol class="arabic">
<li><p class="first">Generate a key, it’s same as ssh but in <code class="docutils literal notranslate"><span class="pre">id_ed25519</span></code> format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span><span class="o">-</span><span class="n">keygen</span> <span class="o">-</span><span class="n">t</span> <span class="n">ed25519</span> <span class="o">-</span><span class="n">f</span> <span class="n">tmp</span><span class="o">-</span><span class="n">key</span> <span class="o">-</span><span class="n">P</span> <span class="s2">&quot;&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">Upload the private key into CI for <code class="docutils literal notranslate"><span class="pre">CIRUELA_KEY</span></code>, for example for
travis you may use <code class="docutils literal notranslate"><span class="pre">travis</span> <span class="pre">encrypt</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">travis</span> <span class="n">encrypt</span> <span class="s2">&quot;CIRUELA_KEY=$(cat tmp-key)&quot;</span> <span class="o">--</span><span class="n">add</span>
</pre></div>
</div>
</li>
<li><p class="first">Add upload command to the task:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ciruela</span> <span class="n">sync</span> <span class="n">server</span><span class="o">.</span><span class="n">name</span> <span class="o">--</span><span class="n">replace</span> <span class="o">./</span><span class="n">cfg</span><span class="p">:</span><span class="o">/</span><span class="n">my</span><span class="o">-</span><span class="n">daemonio</span><span class="o">/</span><span class="n">current</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="reloading-configs">
<span id="reloading"></span><h3>Reloading Configs<a class="headerlink" href="#reloading-configs" title="Permalink to this headline">¶</a></h3>
<p>All of this works if your service can pick up configuration on the fly without
any kind of signals.</p>
<p>Making signals for configuration reload is out of scope of this article but
here are some ideas:</p>
<ol class="arabic simple">
<li>You can set a script that compares directory timestamp and signals service
if that changes. Ciruela replaces directory atomically so reloading is safe
at any time (or as quick as the directory is new)</li>
<li>You can use some special programs for that (but I’m not sure they
are suited for production):<ul>
<li><a class="reference external" href="https://github.com/remy/nodemon">nodemon</a></li>
<li><a class="reference external" href="https://github.com/cortesi/modd">modd</a></li>
<li><a class="reference external" href="https://pythonhosted.org/watchdog/">watchdog</a></li>
</ul>
</li>
<li>Some supervisors like <a class="reference external" href="http://supervisord.org/">supervisord</a> (<a class="reference external" href="http://supervisord.org/api.html">API</a>)
and <a class="reference external" href="https://www.freedesktop.org/wiki/Software/systemd/">systemd</a> (<a class="reference external" href="https://www.freedesktop.org/wiki/Software/systemd/dbus/">API</a>) have RPC for the task</li>
<li>Maybe you have a UI for the service?</li>
</ol>
<p>Just to show you that (1) is not as scareful as it sounds, here is an
example script for nginx:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/sh</span>

<span class="nv">DIR</span><span class="o">=</span>/etc/nginx/conf
<span class="nv">CMD</span><span class="o">=</span><span class="s2">&quot;nginx -s reload&quot;</span>

<span class="nv">last_stat</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>stat --format<span class="o">=</span><span class="s2">&quot;%Z/%Y/%d:%i&quot;</span> <span class="s2">&quot;</span><span class="nv">$DIR</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="s2">&quot;&lt;absent&gt;&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="k">while</span> sleep <span class="m">1</span><span class="p">;</span> <span class="k">do</span>
  <span class="nv">new_stat</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>stat --format<span class="o">=</span><span class="s2">&quot;%Z/%Y/%d:%i&quot;</span> <span class="s2">&quot;</span><span class="nv">$DIR</span><span class="s2">&quot;</span> <span class="o">||</span> <span class="s2">&quot;&lt;absent&gt;&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;</span><span class="nv">$last_stat</span><span class="s2">&quot;</span> !<span class="o">=</span> <span class="s2">&quot;</span><span class="nv">$new_stat</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">$CMD</span>
  endif
<span class="k">done</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The script doesn’t detect most changes done on individual config
files, but ciruela always replaces the directory with the new one. And we
detect it by checking inode number <code class="docutils literal notranslate"><span class="pre">&quot;%i&quot;</span></code>. Other stat parameters here are
just for being more cautious.</p>
</div>
</div>
<div class="section" id="additional-options">
<h3>Additional Options<a class="headerlink" href="#additional-options" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">If your service has only one configuration file, you should put it into
a directory anyway, as ciruela syncs directories. But it’s a good idea
since you can add another include file later or just put a README into
the dir.</p>
</li>
<li><p class="first">You may want to check configs before uploading.
For example run <code class="docutils literal notranslate"><span class="pre">daemonio</span> <span class="pre">--config=./local_config_dir</span> <span class="pre">--check-config</span></code>
on the CI server before upload.</p>
</li>
<li><p class="first">You can override keys via <code class="docutils literal notranslate"><span class="pre">-i</span></code>, <code class="docutils literal notranslate"><span class="pre">-e</span></code> (see <code class="docutils literal notranslate"><span class="pre">ciruela</span> <span class="pre">sync</span> <span class="pre">--help</span></code>)</p>
</li>
<li><p class="first">You can upload multiple dirs simultaneously via:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ciruela</span> <span class="n">sync</span> <span class="n">s1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">org</span> <span class="o">--</span><span class="n">replace</span> <span class="o">./</span><span class="n">dir1</span><span class="p">:</span><span class="o">/</span><span class="n">dest1</span> <span class="o">--</span><span class="n">replace</span> <span class="o">./</span><span class="n">dir2</span><span class="p">:</span><span class="o">/</span><span class="n">dest</span>
</pre></div>
</div>
</li>
<li><p class="first">If server name resolves to multiple IP addresses, ciruela will try to upload
to at most three of them (random ones if there are more) and will return
non-zero exit status if none of them accepts the upload.</p>
</li>
<li><p class="first">Multiple names on command-line treated as a separate clusters. So ciruela
will upload on three servers on each of them:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ciruela</span> <span class="n">sync</span> <span class="n">s1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">org</span> <span class="n">s1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">org</span> <span class="o">--</span><span class="n">replace</span> <span class="o">./</span><span class="n">dir1</span><span class="p">:</span><span class="o">/</span><span class="n">dest1</span>
</pre></div>
</div>
<p>This will report upload progress for every cluster on it’s own.</p>
<p>If these are individual servers use <code class="docutils literal notranslate"><span class="pre">-m</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ciruela</span> <span class="n">sync</span> <span class="o">-</span><span class="n">m</span> <span class="n">s1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">org</span> <span class="n">s1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">org</span> <span class="o">--</span><span class="n">replace</span> <span class="o">./</span><span class="n">dir1</span><span class="p">:</span><span class="o">/</span><span class="n">dest1</span>
</pre></div>
</div>
<p>With &gt; 4 servers this makes ciruela upload to at least 75% of them and
tolerate few failures. Just like it does for a single cluster name and
multiple servers behind.</p>
</li>
<li><p class="first">Mutliple instances of <code class="docutils literal notranslate"><span class="pre">daemonio</span></code> can be configured with a single upload key
you may put multiple configurations into the single directory:</p>
<ul class="simple">
<li>/etc/daemonio-configs/my_daemonio</li>
<li>/etc/daemonio-configs/other_daemonio</li>
</ul>
</li>
<li><p class="first">Or you can group all configured services under single folder (if you don’t
need to differentiate permissions for them):</p>
<ul class="simple">
<li>/etc/syncing-configs/daemonio</li>
<li>/etc/syncing-configs/nginx</li>
<li>/etc/syncing-configs/my-other-service</li>
</ul>
</li>
</ul>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Ciruela</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">User Guide:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Use Cases</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Syncing Configs</a></li>
<li class="toctree-l2"><a class="reference internal" href="editing-configs.html">Remote Editing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../config/index.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../client/index.html">Command-line Client Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../compatibility.html">Version Compatibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Ciruela Changes by Version</a></li>
</ul>
<p class="caption"><span class="caption-text">Developer Guide:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../protocols/index.html">Network Protocols</a></li>
<li class="toctree-l1"><a class="reference internal" href="../database/index.html">Storage Bookkeeping and Management</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="index.html">Use Cases</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Use Cases</a></li>
      <li>Next: <a href="editing-configs.html" title="next chapter">Remote Editing</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Paul Colomiets.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/use-cases/syncing-configs.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>